@model DataLayer.Entities.Permission.Role

@{
    ViewData["Title"] = "Role Details - " + Model.DisplayName;
}

<div class="fade-in">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent mb-2">
                Role Details
            </h1>
            <p class="text-slate-400">View complete information about this role</p>
        </div>
        <div class="flex items-center space-x-3">
            @if (Model.RoleName != "SuperAdmin")
            {
                <a asp-action="Edit" asp-route-id="@Model.RoleId" class="px-6 py-3 bg-green-500/20 text-green-400 border border-green-500/30 rounded-lg hover:bg-green-500/30 transition-all">
                    <i class="fas fa-edit mr-2"></i>
                    Edit Role
                </a>
            }
            <a asp-action="Index" class="px-6 py-3 bg-slate-700/50 text-slate-300 rounded-lg hover:bg-slate-700 transition-all">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to List
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Role Information -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Basic Info Card -->
            <div class="glass-card rounded-xl p-6">
                <div class="flex items-center space-x-4 mb-6">
                    <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white text-2xl">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white">@Model.DisplayName</h2>
                        <p class="text-slate-400">@Model.RoleName</p>
                    </div>
                    @if (Model.IsActive)
                    {
                        <span class="ml-auto px-4 py-2 inline-flex text-sm font-semibold rounded-full bg-green-500/20 text-green-400 border border-green-500/30">
                            <i class="fas fa-check-circle mr-2"></i>Active
                        </span>
                    }
                    else
                    {
                        <span class="ml-auto px-4 py-2 inline-flex text-sm font-semibold rounded-full bg-red-500/20 text-red-400 border border-red-500/30">
                            <i class="fas fa-times-circle mr-2"></i>Inactive
                        </span>
                    }
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="text-sm text-slate-400 mb-1 block">Role Name</label>
                        <p class="text-white font-medium">@Model.RoleName</p>
                    </div>
                    <div>
                        <label class="text-sm text-slate-400 mb-1 block">Display Name</label>
                        <p class="text-white font-medium">@Model.DisplayName</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm text-slate-400 mb-1 block">Description</label>
                        <p class="text-white">@(Model.Description ?? "No description provided")</p>
                    </div>
                    <div>
                        <label class="text-sm text-slate-400 mb-1 block">Created Date</label>
                        <p class="text-white">@Model.CreateDate.ToString("MMM dd, yyyy")</p>
                    </div>
                    <div>
                        <label class="text-sm text-slate-400 mb-1 block">Status</label>
                        <p class="text-white">@(Model.IsActive ? "Active" : "Inactive")</p>
                    </div>
                </div>
            </div>

            <!-- Permissions Card -->
            <div class="glass-card rounded-xl p-6">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-key mr-3 text-purple-400"></i>
                    Assigned Permissions
                    <span class="ml-auto text-sm font-normal text-slate-400">@Model.RolePermissions.Count() permissions</span>
                </h3>

                @if (Model.RolePermissions.Any())
                {
                    var permissionsByCategory = Model.RolePermissions
                        .Select(rp => rp.Permission)
                        .GroupBy(p => p.Category ?? "Other")
                        .OrderBy(g => g.Key);

                    <div class="space-y-4">
                        @foreach (var category in permissionsByCategory)
                        {
                            <div>
                                <h4 class="text-sm font-semibold text-purple-400 mb-2 uppercase">@category.Key</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    @foreach (var permission in category.OrderBy(p => p.DisplayName))
                                    {
                                        <div class="flex items-center space-x-2 bg-slate-800/30 rounded-lg px-3 py-2">
                                            <i class="fas fa-check text-green-400 text-sm"></i>
                                            <span class="text-slate-300 text-sm">@permission.DisplayName</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-8">
                        <i class="fas fa-key text-4xl text-slate-600 mb-3"></i>
                        <p class="text-slate-400">No permissions assigned to this role</p>
                    </div>
                }
            </div>

            <!-- Assigned Users Card -->
            <div class="glass-card rounded-xl p-6">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-users mr-3 text-blue-400"></i>
                    Assigned Users
                    <span class="ml-auto text-sm font-normal text-slate-400">@Model.UserRoles.Count() users</span>
                </h3>

                @if (Model.UserRoles.Any())
                {
                    <div class="space-y-2">
                        @foreach (var userRole in Model.UserRoles.OrderBy(ur => ur.User.UserName))
                        {
                            <div class="flex items-center justify-between bg-slate-800/30 rounded-lg px-4 py-3">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold">
                                        @userRole.User.UserName.Substring(0, 1).ToUpper()
                                    </div>
                                    <div>
                                        <p class="text-white font-medium">@(userRole.User.FirstName + " " + userRole.User.LastName)</p>
                                        <p class="text-sm text-slate-400">@@@userRole.User.UserName</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-slate-400">Assigned on</p>
                                    <p class="text-sm text-slate-300">@userRole.AssignedDate.ToString("MMM dd, yyyy")</p>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-8">
                        <i class="fas fa-users text-4xl text-slate-600 mb-3"></i>
                        <p class="text-slate-400">No users assigned to this role yet</p>
                    </div>
                }
            </div>
        </div>

        <!-- Stats Sidebar -->
        <div class="space-y-6">
            <!-- Quick Stats -->
            <div class="glass-card rounded-xl p-6">
                <h3 class="text-lg font-bold text-white mb-4">Quick Stats</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 bg-slate-800/30 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-key text-purple-400"></i>
                            <span class="text-slate-300">Permissions</span>
                        </div>
                        <span class="text-white font-bold">@Model.RolePermissions.Count()</span>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-slate-800/30 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-users text-blue-400"></i>
                            <span class="text-slate-300">Users</span>
                        </div>
                        <span class="text-white font-bold">@Model.UserRoles.Count()</span>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-slate-800/30 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-calendar text-green-400"></i>
                            <span class="text-slate-300">Created</span>
                        </div>
                        <span class="text-white font-bold text-sm">@Model.CreateDate.ToString("MMM yyyy")</span>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-slate-800/30 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-power-off text-yellow-400"></i>
                            <span class="text-slate-300">Status</span>
                        </div>
                        <span class="@(Model.IsActive ? "text-green-400" : "text-red-400") font-bold">
                            @(Model.IsActive ? "Active" : "Inactive")
                        </span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="glass-card rounded-xl p-6">
                <h3 class="text-lg font-bold text-white mb-4">Actions</h3>
                <div class="space-y-2">
                    @if (Model.RoleName != "SuperAdmin")
                    {
                        <a asp-action="Edit" asp-route-id="@Model.RoleId" 
                           class="flex items-center justify-center space-x-2 w-full px-4 py-3 bg-green-500/20 text-green-400 border border-green-500/30 rounded-lg hover:bg-green-500/30 transition-all">
                            <i class="fas fa-edit"></i>
                            <span>Edit Role</span>
                        </a>

                        <button onclick="toggleActive(@Model.RoleId, '@Model.RoleName', @Model.IsActive.ToString().ToLower())"
                                class="flex items-center justify-center space-x-2 w-full px-4 py-3 bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 rounded-lg hover:bg-yellow-500/30 transition-all">
                            <i class="fas fa-power-off"></i>
                            <span>@(Model.IsActive ? "Deactivate" : "Activate")</span>
                        </button>

                        @if (!Model.UserRoles.Any())
                        {
                            <button onclick="deleteRole(@Model.RoleId, '@Model.RoleName')"
                                    class="flex items-center justify-center space-x-2 w-full px-4 py-3 bg-red-500/20 text-red-400 border border-red-500/30 rounded-lg hover:bg-red-500/30 transition-all">
                                <i class="fas fa-trash"></i>
                                <span>Delete Role</span>
                            </button>
                        }
                    }
                    else
                    {
                        <div class="p-4 bg-slate-800/50 border border-slate-700 rounded-lg text-center">
                            <i class="fas fa-shield-halved text-3xl text-slate-600 mb-2"></i>
                            <p class="text-sm text-slate-400">This role is protected and cannot be modified</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Info Box -->
            @if (Model.RoleName == "SuperAdmin")
            {
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                    <p class="text-sm text-blue-400">
                        <i class="fas fa-info-circle mr-2"></i>
                        This is a protected system role and cannot be deleted, deactivated, or modified.
                    </p>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        async function toggleActive(roleId, roleName, isActive) {
            const action = isActive ? 'deactivate' : 'activate';
            if (!confirm(`Are you sure you want to ${action} this role?`)) {
                return;
            }

            try {
                const response = await fetch('/Admin/Roles/ToggleActive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: roleId })
                });

                const result = await response.json();
                
                if (result.success) {
                    location.reload();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert('Error performing operation');
            }
        }

        async function deleteRole(roleId, roleName) {
            if (!confirm(`Are you sure you want to delete the role "${roleName}"?`)) {
                return;
            }

            try {
                const response = await fetch('/Admin/Roles/Delete?id=' + roleId, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    window.location.href = '/Admin/Roles';
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert('Error performing operation');
            }
        }
    </script>
}
